<mat-card class="installment-calculator">
  <mat-card-header>
    <mat-card-title>
      <mat-icon>calculate</mat-icon>
      Calculadora de Cuotas
    </mat-card-title>
    <mat-card-subtitle>
      Simula tu compra en cuotas
    </mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <form [formGroup]="form" class="calculator-form">
      <!-- Toggle para activar/desactivar cálculo automático -->
      <div class="form-row auto-calculate-toggle">
        <mat-checkbox formControlName="calculateNow" (change)="onCalculateNowToggle()">
          Calcular automáticamente
        </mat-checkbox>
      </div>

      <!-- Monto de la compra -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Monto de la compra</mat-label>
          <input matInput 
                 type="number" 
                 formControlName="amount"
                 placeholder="0.00"
                 [readonly]="amount > 0">
          <span matPrefix>$&nbsp;</span>
          <mat-error *ngIf="form.get('amount')?.hasError('required')">
            El monto es requerido
          </mat-error>
          <mat-error *ngIf="form.get('amount')?.hasError('min')">
            El monto mínimo es $1,000
          </mat-error>
          <mat-error *ngIf="form.get('amount')?.hasError('max')">
            El monto máximo es $500,000
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Cantidad de cuotas -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Cantidad de cuotas</mat-label>
          <mat-select formControlName="installmentsCount" (selectionChange)="onInstallmentsCountChange()">
            <mat-option *ngFor="let count of availableInstallments()" [value]="count">
              {{count}} cuotas
            </mat-option>
          </mat-select>
          <mat-error *ngIf="form.get('installmentsCount')?.hasError('required')">
            Selecciona la cantidad de cuotas
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Fecha de inicio -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Fecha de primera cuota</mat-label>
          <input matInput 
                 [matDatepicker]="picker" 
                 formControlName="startDate"
                 (dateChange)="onStartDateChange()">
          <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
          <mat-error *ngIf="form.get('startDate')?.hasError('required')">
            Selecciona la fecha de inicio
          </mat-error>
        </mat-form-field>
      </div>
    </form>

    <!-- Loading state -->
    <div *ngIf="isLoading" class="loading-container">
      <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
      <p>Calculando cuotas...</p>
    </div>

    <!-- Error state -->
    <div *ngIf="hasError" class="error-container">
      <mat-icon color="warn">error</mat-icon>
      <p>{{ hasError }}</p>
    </div>

    <!-- Preview Results -->
    <div *ngIf="currentPreview && showPreview && !isLoading" class="preview-container">
      <div class="preview-header">
        <h3>Resumen del Plan de Cuotas</h3>
        <mat-icon>visibility</mat-icon>
      </div>

      <!-- Summary Cards -->
      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-label">Monto Original</div>
          <div class="summary-value primary">{{ formatCurrency(currentPreview.totalAmount) }}</div>
        </div>
        
        <div class="summary-card">
          <div class="summary-label">Cuota Mensual</div>
          <div class="summary-value accent">{{ formatCurrency(currentPreview.installmentAmount) }}</div>
        </div>
        
        <div class="summary-card">
          <div class="summary-label">Total a Pagar</div>
          <div class="summary-value">{{ formatCurrency(currentPreview.totalToPay) }}</div>
        </div>
        
        <div class="summary-card">
          <div class="summary-label">Total Intereses</div>
          <div class="summary-value warn">{{ formatCurrency(currentPreview.totalInterest) }}</div>
        </div>
      </div>

      <!-- Additional Info -->
      <div class="additional-info" *ngIf="currentPreview.adminFee > 0 || currentPreview.interestRate">
        <div class="info-row" *ngIf="currentPreview.adminFee > 0">
          <span class="info-label">Gastos administrativos:</span>
          <span class="info-value">{{ formatCurrency(currentPreview.adminFee) }}</span>
        </div>
        <div class="info-row" *ngIf="currentPreview.interestRate">
          <span class="info-label">Tasa de interés:</span>
          <span class="info-value">{{ getInterestRateDisplay() }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Primera cuota:</span>
          <span class="info-value">{{ formatDate(currentPreview.startDate) }}</span>
        </div>
      </div>

      <!-- Installments Table -->
      <div class="installments-table-container" *ngIf="currentPreview.installments && currentPreview.installments.length > 0">
        <h4>Detalle de Cuotas</h4>
        <div class="table-wrapper">
          <table mat-table [dataSource]="currentPreview.installments" class="installments-table">
            <!-- Installment Number Column -->
            <ng-container matColumnDef="installmentNumber">
              <th mat-header-cell *matHeaderCellDef>Cuota</th>
              <td mat-cell *matCellDef="let installment">#{{ installment.number }}</td>
            </ng-container>

            <!-- Due Date Column -->
            <ng-container matColumnDef="dueDate">
              <th mat-header-cell *matHeaderCellDef>Vencimiento</th>
              <td mat-cell *matCellDef="let installment">{{ formatDate(installment.dueDate) }}</td>
            </ng-container>

            <!-- Amount Column -->
            <ng-container matColumnDef="amount">
              <th mat-header-cell *matHeaderCellDef>Importe</th>
              <td mat-cell *matCellDef="let installment" class="amount-cell">
                {{ formatCurrency(installment.amount) }}
              </td>
            </ng-container>

            <!-- Principal Column -->
            <ng-container matColumnDef="principal">
              <th mat-header-cell *matHeaderCellDef>Capital</th>
              <td mat-cell *matCellDef="let installment">{{ formatCurrency(installment.principal) }}</td>
            </ng-container>

            <!-- Interest Column -->
            <ng-container matColumnDef="interest">
              <th mat-header-cell *matHeaderCellDef>Interés</th>
              <td mat-cell *matCellDef="let installment">{{ formatCurrency(installment.interest) }}</td>
            </ng-container>

            <!-- Fee Column -->
            <ng-container matColumnDef="fee">
              <th mat-header-cell *matHeaderCellDef>Gastos</th>
              <td mat-cell *matCellDef="let installment">
                <span *ngIf="installment.fee > 0">{{ formatCurrency(installment.fee) }}</span>
                <span *ngIf="installment.fee === 0">-</span>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </div>
      </div>

      <!-- Action Button -->
      <div class="action-container" *ngIf="canSelectInstallments">
        <button mat-raised-button 
                color="primary" 
                (click)="onSelectInstallments()"
                class="select-button">
          <mat-icon>check_circle</mat-icon>
          Seleccionar este Plan
        </button>
      </div>
    </div>

    <!-- Empty state when no calculation -->
    <div *ngIf="!currentPreview && !isLoading && !hasError && form.get('calculateNow')?.value" 
         class="empty-state">
      <mat-icon>info</mat-icon>
      <p>Completa los datos para ver la simulación de cuotas</p>
    </div>

    <!-- Disabled calculation state -->
    <div *ngIf="!form.get('calculateNow')?.value" class="disabled-state">
      <mat-icon>pause_circle</mat-icon>
      <p>Cálculo automático desactivado. Activa la opción para ver la simulación.</p>
    </div>
  </mat-card-content>
</mat-card>