<div class="chat-container">
  <!-- Header del Chat -->
  <mat-card class="chat-card">
    <div class="chat-header">
      <div class="header-left">
        <mat-icon>smart_toy</mat-icon>
        <div class="header-info">
          <h2>Chatbot Financiero</h2>
          <span class="status">{{conversationId ? 'Conversación activa' : 'Nueva conversación'}}</span>
        </div>
      </div>
      <button 
        mat-icon-button 
        (click)="startNewChat()" 
        matTooltip="Iniciar nueva conversación"
        class="new-chat-btn">
        <mat-icon>add_comment</mat-icon>
      </button>
    </div>

    <!-- Área de Mensajes -->
    <div class="messages-container" #chatContainer>
      <div 
        *ngFor="let msg of messages" 
        class="message-wrapper"
        [class.user-message]="msg.role === 'user'"
        [class.assistant-message]="msg.role === 'assistant'">
        
        <div class="message-bubble">
          <div class="message-content">
            <p class="message-text">{{ msg.message }}</p>
          </div>
          
          <!-- Metadata (solo para mensajes del asistente) -->
          <div class="message-meta" *ngIf="msg.role === 'assistant' && (msg.inferredContext || msg.inferredPeriod)">
            <mat-chip-set class="meta-chips">
              <mat-chip *ngIf="msg.inferredPeriod" class="period-chip">
                <mat-icon>calendar_today</mat-icon>
                {{ msg.inferredPeriod }}
              </mat-chip>
              <mat-chip *ngIf="msg.inferredContext" class="context-chip">
                <mat-icon>category</mat-icon>
                {{ msg.inferredContext }}
              </mat-chip>
            </mat-chip-set>
          </div>

          <!-- Sugerencias Rápidas -->
          <div class="quick-suggestions" *ngIf="msg.quickSuggestions && msg.quickSuggestions.length > 0">
            <p class="suggestions-label">Preguntas relacionadas:</p>
            <div class="suggestions-buttons">
              <button 
                mat-stroked-button 
                *ngFor="let suggestion of msg.quickSuggestions"
                (click)="useSuggestion(suggestion)"
                class="suggestion-btn">
                {{ suggestion }}
              </button>
            </div>
          </div>

          <span class="message-time">{{ formatTime(msg.timestamp) }}</span>
        </div>

        <!-- Avatar -->
        <div class="message-avatar">
          <mat-icon *ngIf="msg.role === 'user'" class="user-icon">person</mat-icon>
          <mat-icon *ngIf="msg.role === 'assistant'" class="bot-icon">smart_toy</mat-icon>
        </div>
      </div>

      <!-- Indicador de "escribiendo..." -->
      <div class="typing-indicator" *ngIf="loading">
        <mat-icon class="bot-icon">smart_toy</mat-icon>
        <div class="typing-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </div>

    <!-- Input de Mensaje -->
    <div class="message-input-container">
      <mat-form-field appearance="outline" class="message-input">
        <mat-label>Escribe tu mensaje...</mat-label>
        <textarea 
          matInput 
          [(ngModel)]="currentMessage"
          (keydown)="onKeyDown($event)"
          [disabled]="loading"
          rows="2"
          placeholder="Ejemplo: ¿Cuánto gasté hoy con tarjetas?">
        </textarea>
        <mat-hint>Presiona Enter para enviar, Shift+Enter para nueva línea</mat-hint>
      </mat-form-field>

      <button 
        mat-fab 
        color="primary"
        (click)="sendMessage()"
        [disabled]="!currentMessage.trim() || loading"
        class="send-button">
        <mat-icon>send</mat-icon>
      </button>
    </div>

    <!-- Error Message -->
    <div class="error-message" *ngIf="error">
      <mat-icon>error</mat-icon>
      {{ error }}
    </div>
  </mat-card>

  <!-- Tarjeta de Ayuda -->
  <mat-card class="help-card">
    <mat-card-header>
      <mat-icon mat-card-avatar>help_outline</mat-icon>
      <mat-card-title>¿Qué puedo preguntarle?</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <ul class="help-list">
        <li>
          <mat-icon>trending_down</mat-icon>
          <span><strong>Gastos:</strong> "¿Cuánto gasté hoy/ayer/esta semana?"</span>
        </li>
        <li>
          <mat-icon>credit_card</mat-icon>
          <span><strong>Tarjetas:</strong> "Muéstrame mis tarjetas", "¿Cuál tarjeta tiene más deuda?"</span>
        </li>
        <li>
          <mat-icon>payment</mat-icon>
          <span><strong>Cuotas:</strong> "Estado de cuotas", "¿Cuándo vence la próxima cuota?"</span>
        </li>
        <li>
          <mat-icon>trending_up</mat-icon>
          <span><strong>Ingresos:</strong> "Ingresos del mes", "Balance general"</span>
        </li>
        <li>
          <mat-icon>store</mat-icon>
          <span><strong>Comercios:</strong> "¿Dónde gasté más?", "Top comercios"</span>
        </li>
      </ul>
      <p class="help-note">
        <mat-icon>info</mat-icon>
        El chatbot infiere automáticamente el período y contexto de tu pregunta. ¡Solo pregunta naturalmente!
      </p>
    </mat-card-content>
  </mat-card>
</div>
